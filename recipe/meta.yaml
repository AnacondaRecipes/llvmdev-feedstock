{% set version = "8.0.0" %}
{% set sha256 = "8872be1b12c61450cacc82b3d153eab02be2546ef34fa3580ed14137bb26224c" %}

{% set build_number = 2 %}
{% set major_ver = version.split(".")[0] %}

package:
  name: llvm
  version: {{ version }}

source:
  url: http://llvm.org/releases/{{ version }}/llvm-{{ version }}.src.tar.xz
  sha256: {{ sha256 }}
  patches:
    - llvm-lto-static.patch   # [win]
    # TODO add back for sake of llvm-lit - partial-testing.patch
    - D47188-svml-VF.patch    # Fixes vectorizer and extends SVML support
    # Revert an upstream change for Numba
    # ref: https://github.com/numba/llvmlite/blob/v0.29.0/conda-recipes/0001-Revert-Limit-size-of-non-GlobalValue-name.patch
    - 0001-Revert-Limit-size-of-non-GlobalValue-name.patch


build:
  number: {{ build_number }}
  skip:  true  # [(win and vc<14) or aarch64 or ppc64le]

requirements:
  build:
    - {{ compiler('cxx') }}   # [not osx]
    - cmake
    - ninja     # [win]
    - python    3.7
    - make

test:
  files:
    - numba-3016.ll

  commands:
    - $PREFIX/bin/llvm-config --libs                         # [not win]
    - $PREFIX/bin/llc -version                               # [not win]

    - if not exist %LIBRARY_INC%\\llvm\\Pass.h exit 1        # [win]

    - test -f $PREFIX/include/llvm/Pass.h                    # [unix]
    - test -f $PREFIX/lib/libLLVMCore.a                      # [not win]

outputs:
  # Contains everything
  - name: llvmdev
    script: install_llvm.sh                         # [not win]
    script: install_llvm.bat                        # [win]
    requirements:
      build:
        - {{ compiler('cxx') }}    # [not osx]
        - cmake
        - ninja     # [win]
        - python    3.7
      host:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}
        - {{ pin_subpackage("llvm-tools", exact=True) }}
      run:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}
        - {{ pin_subpackage("llvm-tools", exact=True) }}
        - libcxx >={{ cxx_compiler_version }}  # [osx]

  # Contains the shared libraries. To make different LLVM libraries co-installable
  # soversion is appended to the package name.
  - name: libllvm{{ major_ver }}
    script: install_llvm.sh                         # [not win]
    build:
      run_exports:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}  # [not win]
    requirements:
      build:
        - {{ compiler('cxx') }}    # [not osx]
        - cmake
        - ninja     # [win]
        - python    3.7
      run:
        - libcxx >={{ cxx_compiler_version }}  # [osx]

  # This is a meta package so that people can use the latest libllvm and also
  # for run_exports
  - name: libllvm
    build:
      run_exports:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}  # [not win]
    requirements:
      run:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}  # [not win]
      run_constrained:
        - llvmdev   {{ version }}                                  # [not win]

  # Contains LLVM tools
  - name: llvm-tools
    script: install_llvm.sh                         # [not win]
    script: install_llvm.bat                        # [win]
    requirements:
      build:
        - {{ compiler('cxx') }}    # [not osx]
        - cmake
        - ninja     # [win]
        - python    3.7
      host:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}
      run:
        - {{ pin_subpackage("libllvm" + major_ver, exact=True) }}
      run_constrained:
        - llvmdev   {{ version }}

about:
  home: http://llvm.org/
  dev_url: https://github.com/llvm-mirror/llvm
  license: NCSA
  license_file: LICENSE.TXT
  summary: Development headers and libraries for LLVM

extra:
  recipe-maintainers:
    - inducer
    - pitrou
    - jakirkham
    - mingwandroid
    - mattwala
    - SylvainCorlay
    - isuruf
